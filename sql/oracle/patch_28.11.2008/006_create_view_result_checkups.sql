/* Создание просмотра результатов журнала осмотров */

CREATE OR REPLACE VIEW S_RESULT_CHECKUPS
AS
  SELECT JC.*, 
         C.CYCLE_NUM,
         PT.NAME AS POINT_NAME,
		 MT.NAME AS MEASURE_TYPE_NAME,
		 DV.NAME AS DEFECT_VIEW_NAME,
         P1.FNAME||' '||P1.NAME||' '||P1.SNAME AS WHO_ENTER_NAME,
         P2.FNAME||' '||P2.NAME||' '||P2.SNAME AS WHO_CONFIRM_NAME,
		 OT.OBJECT_NAME,
		 OT.OBJECT_PATHS
    FROM JOURNAL_CHECKUPS JC, CYCLES C, POINTS PT, MEASURE_TYPES MT, 
         DEFECT_VIEWS DV, PERSONNELS P1, PERSONNELS P2,
        (SELECT OT1.OBJECT_ID, 
		        O1.NAME AS OBJECT_NAME, 
		        SUBSTR(MAX(SYS_CONNECT_BY_PATH(O1.NAME,'\')),2) AS OBJECT_PATHS 
           FROM OBJECT_TREES OT1, OBJECTS O1 
          WHERE OT1.OBJECT_ID=O1.OBJECT_ID 
          START WITH OT1.PARENT_ID IS NULL 
        CONNECT BY OT1.PARENT_ID=PRIOR OT1.OBJECT_TREE_ID 
          GROUP BY OT1.OBJECT_ID,O1.NAME) OT		 
   WHERE JC.POINT_ID=PT.POINT_ID
	 AND JC.CYCLE_ID=C.CYCLE_ID
     AND JC.MEASURE_TYPE_ID=MT.MEASURE_TYPE_ID
     AND JC.DEFECT_VIEW_ID=DV.DEFECT_VIEW_ID
     AND JC.WHO_ENTER=P1.PERSONNEL_ID
     AND JC.WHO_CONFIRM=P2.PERSONNEL_ID (+)
	 AND PT.OBJECT_ID=OT.OBJECT_ID (+)

--

/* Фиксация изменений БД */

COMMIT